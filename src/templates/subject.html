{% extends 'base.html' %}
{% block content %}
<div class="flex items-start justify-between flex-wrap gap-4 mb-4">
  <div>
    <h2 class="text-2xl font-semibold flex items-center gap-3">
      <span id="subject-code-display">{{subject.subject_code}}</span>
      <span class="text-base font-normal opacity-70" id="subject-name-display">{{subject.subject_name}}</span>
      <button id="edit-subject-btn" class="btn btn-xs btn-circle btn-ghost" type="button" onclick="showSubjectEditForm()" title="Edit subject">&#9881;</button>
    </h2>
    <form id="subject-edit-form" method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/update" class="flex gap-2 mt-2 hidden" onsubmit="return submitSubjectEditForm(event)">
      <input type="hidden" name="year" value="{{year}}" />
      <input name="subject_code" class="input input-xs w-24" value="{{subject.subject_code}}" required />
      <input name="subject_name" class="input input-xs w-48" value="{{subject.subject_name}}" required />
      <button type="submit" class="btn btn-xs btn-primary">Save</button>
      <button type="button" class="btn btn-xs" onclick="hideSubjectEditForm()">Cancel</button>
    </form>
    <p class="mt-1 text-xs opacity-70 uppercase tracking-wide">Semester {{semester}} — {{year}}</p>
  </div>
  <div class="flex gap-2">
  <a href="/semester/{{semester}}?year={{year}}" class="btn btn-xs btn-outline">Back to Semester</a>
    <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/delete" onsubmit="return confirm('Delete this subject and all related assignments/exams?');">
      <input type="hidden" name="year" value="{{year}}" />
      <button class="btn btn-xs btn-error" type="submit">Delete Subject</button>
    </form>
  </div>
</div>

<div class="p-5 rounded-xl bg-base-100 shadow card-glow mb-6">
  {% if error_messages and error_messages|length %}
    <div class="alert alert-error mb-4 text-sm relative" id="error-alert">
      <button type="button" class="btn btn-xs btn-circle absolute right-2 top-2" onclick="document.getElementById('error-alert').style.display='none'">✕</button>
      <ul class="list-disc ml-4">
        {% for err in error_messages %}<li>{{ err }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}
  <h3 class="font-semibold mb-3 flex items-center gap-2">Add Assignment <span class="badge badge-outline badge-sm">{{ assignments|length }} existing</span></h3>
  <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/assignment/create" class="grid grid-cols-12 gap-3 text-sm">
  <input type="hidden" name="year" value="{{year}}" />
  {% if final_total is not none %}<input type="hidden" name="total_mark" value="{{ final_total }}" />{% endif %}
  {% if effective_exam_weight %}<input type="hidden" name="exam_weight" value="{{ effective_exam_weight }}" />{% endif %}
  {% if ps_exam %}<input type="hidden" name="ps_exam" value="true" />{% endif %}
  {% if ps_exam and ps_factor %}<input type="hidden" name="ps_factor" value="{{ ps_factor }}" />{% endif %}
  <input name="assessment" placeholder="Assessment" class="input input-bordered input-xs col-span-4" required />
  <input id="weighted_mark_input" name="weighted_mark" type="number" step="any" min="0" placeholder="Weighted" class="input input-bordered input-xs col-span-2" />
  <input id="mark_weight_input" name="mark_weight" type="number" step="any" min="0" placeholder="Weight %" class="input input-bordered input-xs col-span-2" />
  <select id="grade_type_select" name="grade_type" class="select select-bordered select-xs col-span-2">
    <option value="numeric">Numeric</option>
    <option value="S">S</option>
    <option value="U">U</option>
  </select>
  <button class="btn btn-xs btn-primary col-span-2" type="submit">Add</button>
  </form>
</div>

<div class="p-5 rounded-xl bg-base-100 shadow card-glow mb-6">
  <h3 class="font-semibold mb-3 flex items-center gap-2">Total Mark
      {% if subject.total_mark is not none and subject.total_mark != 0 %}
        <span class="badge badge-outline badge-sm">Saved</span>
      {% else %}
        <span class="badge badge-outline badge-sm">Not Saved Yet</span>
      {% endif %}
  </h3>
    {% if show_total_mark_saved and subject.total_mark is not none and subject.total_mark != 0 %}
      <div class="alert alert-success mb-2 relative" id="success-alert">
        <button type="button" class="btn btn-xs btn-circle absolute right-2 top-2" onclick="document.getElementById('success-alert').style.display='none'">✕</button>
        Total mark saved successfully.
      </div>
    {% endif %}
  <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/totalMark/save" class="grid grid-cols-12 gap-3 text-sm">
    <input type="hidden" name="year" value="{{year}}" />
    {% if ps_exam %}<input type="hidden" name="ps_exam" value="true" />{% endif %}
    {% if ps_exam and ps_factor %}<input type="hidden" name="ps_factor" value="{{ ps_factor }}" />{% endif %}
    <div class="col-span-4">
      <label class="form-control">
        <span class="label-text text-xs">Desired Final Total Mark</span>
        <input name="total_mark" value="{{ final_total if final_total is not none else '' }}" placeholder="e.g. 75" class="input input-bordered input-xs" />
      </label>
    </div>
    <div class="col-span-4">
      <label class="form-control">
        <span class="label-text text-xs">Exam Weight (%)</span>
        <input disabled value="{{ effective_exam_weight if effective_exam_weight else 0 }}" class="input input-bordered input-xs" />
      </label>
    </div>
    <div class="col-span-2 flex items-end">
      <label class="form-control w-full">
        <span class="label-text text-xs">PS Factor %</span>
        <input name="ps_factor" value="{{ ps_factor if ps_factor is not none else '40' }}" class="input input-bordered input-xs" {% if not ps_exam %}disabled{% endif %} />
      </label>
    </div>
    <div class="col-span-2 flex items-end">
      <label class="label cursor-pointer flex gap-2 items-center text-xs">
        <span>PS Exam?</span>
        <input type="checkbox" name="ps_exam" value="true" class="toggle toggle-xs" {% if ps_exam %}checked{% endif %} onchange="this.form.submit()" />
      </label>
    </div>
    <div class="col-span-4 flex items-end">
      <button class="btn btn-xs btn-secondary w-full" type="submit">Save Target</button>
    </div>
  </form>
  <p class="mt-2 text-xs opacity-70">Provide a desired overall final %; the system derives and stores the required raw exam mark. Exam weight is automatically set to the remaining percentage after assignments (or retained if already created).{% if ps_exam %} PS mode: only {{ effective_scoring_exam_weight }}% (factor {{ ps_factor if ps_factor is not none else 40 }}%) of this weight counts toward the average.{% endif %}</p>
</div>

<div class="mt-8">
  <div class="tabs tabs-boxed w-full mb-4">
    <a class="tab tab-sm tab-active" id="tab-assignments" onclick="showTab('assignments')">Assignments</a>
    <a class="tab tab-sm" id="tab-summary" onclick="showTab('summary')">Summary</a>
  </div>
  <div id="panel-assignments">
    <h4 class="font-semibold mb-2 flex items-center gap-2">Assignments</h4>
    <div class="overflow-x-auto mb-6">
      <table class="table table-sm w-full border-separate border-2 border-gray-400 rounded-xl" style="border-spacing: 0;">
        <thead>
          <tr>
            <th>Assessment</th>
            <th>Weighted</th>
            <th>Unweighted</th>
            <th>Weight</th>
            <th>Type</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
  {% for assignment in assignments|sort(attribute='id') %}
<tr data-assignment-id="{{ assignment.id }}" class="assignment-row">
  <td class="assignment-assessment">{{assignment.assessment}}</td>
  <td class="assignment-weighted">{% if assignment.grade_type in ['S','U'] %}-{% else %}{{ '%.2f' % (assignment.weighted_mark|float) if assignment.weighted_mark is not none else '0.00' }}{% endif %}</td>
  <td class="assignment-unweighted">{% if assignment.grade_type in ['S','U'] %}-{% else %}{{ '%.2f' % (assignment.unweighted_mark|float) if assignment.unweighted_mark is not none else '0.00' }}{% endif %}</td>
  <td class="assignment-mark-weight">{% if assignment.grade_type in ['S','U'] %}-{% else %}{{ '%.2f' % (assignment.mark_weight|float) if assignment.mark_weight is not none else '0.00' }}{% endif %}</td>
  <td class="assignment-grade-type">{{assignment.grade_type}}</td>
  <td class="flex gap-1">
    <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/assignment/{{assignment.id}}/delete" onsubmit="return confirm('Delete assignment?');">
      <input type="hidden" name="year" value="{{year}}" />
      <button class="btn btn-xs btn-error" type="submit">✕</button>
    </form>
    <button class="btn btn-xs btn-outline" type="button" onclick="startInlineEditAssignment('{{ assignment.id }}')">Edit</button>
  </td>
  <td class="assignment-edit-cell" style="display:none;" colspan="6"></td>
  </tr>
{% endfor %}

  <!-- end assignment loop -->
  {% if assignments|length == 0 %}
  <tr><td colspan="6" class="opacity-70">No assignments.</td></tr>
  {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  <div id="panel-summary" class="hidden">
    <h4 class="font-semibold mb-3 flex items-center gap-2">Summary</h4>
    <div class="overflow-x-auto p-2">
  <table class="table table-sm w-full border-separate border-2 border-gray-400 rounded-xl" style="border-spacing: 0;">
        <thead>
          <tr>
            <th>Subject Title</th>
            <th>Assignment Mark</th>
            <th>Assessment Weight</th>
            <th>Final Exam Mark</th>
            <th>Final Exam Mark Weight</th>
            <th>Total Mark</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ subject.subject_name }}</td>
            <td>{{ '%.2f' % assignment_weighted_sum }}</td>
            <td>{{ '%.2f' % assignment_weight_percent }}</td>
            <td>{{ '%.2f' % raw_exam_percent if raw_exam_percent is not none else '-' }}</td>
            <td>{{ '%.2f' % effective_exam_weight if effective_exam_weight else 0 }}</td>
            <td>{{ '%.2f' % average if average is not none else 0 }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
function showSubjectEditForm() {
  document.getElementById('subject-edit-form').classList.remove('hidden');
  document.getElementById('subject-code-display').classList.add('hidden');
  document.getElementById('subject-name-display').classList.add('hidden');
  document.getElementById('edit-subject-btn').classList.add('hidden');
}
function hideSubjectEditForm() {
  document.getElementById('subject-edit-form').classList.add('hidden');
  document.getElementById('subject-code-display').classList.remove('hidden');
  document.getElementById('subject-name-display').classList.remove('hidden');
  document.getElementById('edit-subject-btn').classList.remove('hidden');
}
function submitSubjectEditForm(event) {
  // Optionally use fetch for AJAX, but default is full page reload
  return true;
}
// Debug: Output subject.total_mark to the browser console
console.log('subject.total_mark:', "{{ subject.total_mark }}" );
function showTab(tab) {
  document.getElementById('panel-assignments').classList.toggle('hidden', tab !== 'assignments');
  document.getElementById('panel-summary').classList.toggle('hidden', tab !== 'summary');
  document.getElementById('tab-assignments').classList.toggle('tab-active', tab === 'assignments');
  document.getElementById('tab-summary').classList.toggle('tab-active', tab === 'summary');
}
// On page load, show assignments tab by default
document.addEventListener('DOMContentLoaded', function() {
  showTab('assignments');
});
let editing_assignment_id = null;
function startInlineEditAssignment(id) {
  // Hide any open edit cells
  document.querySelectorAll('.assignment-edit-cell').forEach(cell => cell.style.display = 'none');
  // Fetch the edit form via AJAX and show it in the correct row
  fetch(`/semester/{{semester}}/subject/{{subject.subject_code}}/assignment/${id}/edit?year={{year}}`)
    .then(response => response.text())
    .then(html => {
      const row = document.querySelector(`tr[data-assignment-id='${id}']`);
      const cell = row.querySelector('.assignment-edit-cell');
      cell.innerHTML = html;
      cell.style.display = '';
    });
}
function cancelInlineEditAssignment() {
  // Hide all edit cells
  document.querySelectorAll('.assignment-edit-cell').forEach(cell => cell.style.display = 'none');
}
function submitInlineEditAssignment(event, id) {
  event.preventDefault();
  const form = event.target;
  const url = `/semester/{{semester}}/subject/{{subject.subject_code}}/assignment/${id}/update`;
  const formData = new FormData(form);
  formData.append('year', '{{ year }}');
  fetch(url, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
      return;
    }
    return response.text().then(text => {
      alert(text);
    });
  })
  .catch(err => {
    alert('Error submitting edit.');
  });
  return false;
}
function updateQueryStringParameter(uri, key, value) {
  var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
  var separator = uri.indexOf('?') !== -1 ? "&" : "?";
  if (value === '' || value === null) {
    // Remove param
    return uri.replace(re, '$1').replace(/[?&]$/, '');
  }
  if (uri.match(re)) {
    return uri.replace(re, '$1' + key + "=" + value + '$2');
  }
  else {
    return uri + separator + key + "=" + value;
  }
}
// On page load, set editing_assignment_id from query string
(function(){
  const params = new URLSearchParams(window.location.search);
  editing_assignment_id = params.get('edit');
})();
</script>
{% endblock %}
