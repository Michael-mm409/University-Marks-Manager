{% extends 'base.html' %}
{% block content %}
<div class="flex items-start justify-between flex-wrap gap-4 mb-4">
  <div>
    <h2 class="text-2xl font-semibold flex items-center gap-3">{{subject.subject_code}} <span class="text-base font-normal opacity-70">{{subject.subject_name}}</span></h2>
    <p class="mt-1 text-xs opacity-70 uppercase tracking-wide">Semester {{semester}} — {{year}}</p>
  </div>
  <a href="/semester/{{semester}}?year={{year}}" class="btn btn-xs btn-outline">Back</a>
</div>

<div class="p-5 rounded-xl bg-base-100 shadow card-glow mb-6">
  <h3 class="font-semibold mb-3 flex items-center gap-2">Add Assignment <span class="badge badge-outline badge-sm">{{ assignments|length }} existing</span></h3>
  <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/assignment/create" class="grid grid-cols-12 gap-3 text-sm">
  <input type="hidden" name="year" value="{{year}}" />
  {% if final_total is not none %}<input type="hidden" name="total_mark" value="{{ final_total }}" />{% endif %}
  {% if effective_exam_weight %}<input type="hidden" name="exam_weight" value="{{ effective_exam_weight }}" />{% endif %}
  {% if ps_exam %}<input type="hidden" name="ps_exam" value="true" />{% endif %}
  {% if ps_exam and ps_factor %}<input type="hidden" name="ps_factor" value="{{ ps_factor }}" />{% endif %}
  <input name="assessment" placeholder="Assessment" class="input input-bordered input-xs col-span-4" required />
  <input name="weighted_mark" placeholder="Weighted" class="input input-bordered input-xs col-span-2" />
  <input name="mark_weight" placeholder="Weight %" class="input input-bordered input-xs col-span-2" />
  <select name="grade_type" class="select select-bordered select-xs col-span-2">
    <option value="numeric">Numeric</option>
    <option value="S">S</option>
    <option value="U">U</option>
  </select>
  <button class="btn btn-xs btn-primary col-span-2" type="submit">Add</button>
  </form>
</div>

<div class="p-5 rounded-xl bg-base-100 shadow card-glow mb-6">
  <h3 class="font-semibold mb-3 flex items-center gap-2">Total Mark
    {% if total_mark %}
      <span class="badge badge-outline badge-sm">Existing</span>
    {% else %}
      <span class="badge badge-outline badge-sm">Not Created Yet</span>
    {% endif %}
  </h3>
  <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/totalMark/save" class="grid grid-cols-12 gap-3 text-sm">
    <input type="hidden" name="year" value="{{year}}" />
    {% if ps_exam %}<input type="hidden" name="ps_exam" value="true" />{% endif %}
    {% if ps_exam and ps_factor %}<input type="hidden" name="ps_factor" value="{{ ps_factor }}" />{% endif %}
    <div class="col-span-4">
      <label class="form-control">
        <span class="label-text text-xs">Desired Final Total Mark</span>
        <input name="total_mark" value="{{ final_total if final_total is not none else '' }}" placeholder="e.g. 75" class="input input-bordered input-xs" />
      </label>
    </div>
    <div class="col-span-4">
      <label class="form-control">
        <span class="label-text text-xs">Exam Weight (%)</span>
        <input disabled value="{{ effective_exam_weight if effective_exam_weight else 0 }}" class="input input-bordered input-xs" />
      </label>
    </div>
    <div class="col-span-2 flex items-end">
      <label class="form-control w-full">
        <span class="label-text text-xs">PS Factor %</span>
        <input name="ps_factor" value="{{ ps_factor if ps_factor is not none else '40' }}" class="input input-bordered input-xs" {% if not ps_exam %}disabled{% endif %} />
      </label>
    </div>
    <div class="col-span-2 flex items-end">
      <label class="label cursor-pointer flex gap-2 items-center text-xs">
        <span>PS Exam?</span>
        <input type="checkbox" name="ps_exam" value="true" class="toggle toggle-xs" {% if ps_exam %}checked{% endif %} onchange="this.form.submit()" />
      </label>
    </div>
    <div class="col-span-4 flex items-end">
      <button class="btn btn-xs btn-secondary w-full" type="submit">Save Target</button>
    </div>
  </form>
  <p class="mt-2 text-xs opacity-70">Provide a desired overall final %; the system derives and stores the required raw exam mark. Exam weight is automatically set to the remaining percentage after assignments (or retained if already created).{% if ps_exam %} PS mode: only {{ effective_scoring_exam_weight }}% (factor {{ ps_factor if ps_factor is not none else 40 }}%) of this weight counts toward the average.{% endif %}</p>
</div>

<div class="mt-8">
  <div class="tabs tabs-boxed w-full mb-4">
    <a class="tab tab-sm tab-active" id="tab-assignments" onclick="showTab('assignments')">Assignments</a>
    <a class="tab tab-sm" id="tab-summary" onclick="showTab('summary')">Summary</a>
  </div>
  <div id="panel-assignments">
    <h4 class="font-semibold mb-2 flex items-center gap-2">Assignments</h4>
    <div class="overflow-x-auto mb-6">
      <table class="table table-sm w-full border rounded-xl">
        <thead>
          <tr>
            <th>Assessment</th>
            <th>Weighted</th>
            <th>Unweighted</th>
            <th>Weight</th>
            <th>Type</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for assignment in assignments %}
          <tr>
            <td>{{assignment.assessment}}</td>
            <td>{{assignment.weighted_mark}}</td>
            <td>{{assignment.unweighted_mark}}</td>
            <td>{{assignment.mark_weight}}</td>
            <td>{{assignment.grade_type}}</td>
            <td>
              <form method="post" action="/semester/{{semester}}/subject/{{subject.subject_code}}/assignment/{{assignment.id}}/delete" onsubmit="return confirm('Delete assignment?');">
                <input type="hidden" name="year" value="{{year}}" />
                <button class="btn btn-xs btn-error" type="submit">✕</button>
              </form>
            </td>
          </tr>
        {% else %}
        <tr><td colspan="6" class="opacity-70">No assignments.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div id="panel-summary" class="hidden">
    <h4 class="font-semibold mb-3 flex items-center gap-2">Summary</h4>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="p-4 rounded-lg bg-base-100 border">
        <h5 class="font-semibold mb-2">Breakdown</h5>
        <ul class="text-sm space-y-1">
          <li><span class="opacity-70">Assignment Weighted Sum:</span> {{ assignment_weighted_sum }}</li>
          <li><span class="opacity-70">Assignment Weight %:</span> {{ assignment_weight_percent }}</li>
          <li><span class="opacity-70">Derived Exam Mark:</span> {% if examinations and examinations|length>0 %}{{ examinations[0].exam_mark }}{% else %}-{% endif %}</li>
          <li><span class="opacity-70">Exam Weight %:</span> {{ effective_exam_weight if effective_exam_weight else 0 }}</li>
          <li><span class="opacity-70">Total Weighted Mark:</span> {{ total_weighted }}</li>
          <li><span class="opacity-70">Desired Final %:</span> {{ final_total if final_total is not none else '-' }}</li>
          {% if required_exam_mark is not none %}
          <li><span class="opacity-70">Required Raw Exam %:</span> {{ required_exam_mark }}</li>
          {% endif %}
        </ul>
        <div class="mt-3 text-sm"><span class="opacity-70">Average (%):</span> <span class="font-semibold">{{ average if average is not none else '-' }}</span></div>
      </div>
      
    </div>
  </div>
</div>
<script>
function showTab(which){
  const assignTab=document.getElementById('tab-assignments');
  const summaryTab=document.getElementById('tab-summary');
  const assignPanel=document.getElementById('panel-assignments');
  const summaryPanel=document.getElementById('panel-summary');
  if(which==='assignments'){
    assignTab.classList.add('tab-active');
    summaryTab.classList.remove('tab-active');
    assignPanel.classList.remove('hidden');
    summaryPanel.classList.add('hidden');
  } else {
    summaryTab.classList.add('tab-active');
    assignTab.classList.remove('tab-active');
    summaryPanel.classList.remove('hidden');
    assignPanel.classList.add('hidden');
  }
}
</script>
{% endblock %}
